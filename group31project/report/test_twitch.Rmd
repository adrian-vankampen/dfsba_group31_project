---
title: "Your Document Title"
author: "Document Author"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: readable
    toc: true
    toc_float: true
    number_sections: true
    runtime: shiny
---

```{r, echo = FALSE, message = FALSE, include=FALSE}
source(here::here("scripts/setup.R"))
```

# General Twitch Statistic 

Created in 2011, Twitch has become the number 1 platform for live-streaming. It is a social network that allows people to stream almost whatever they want. 

## Data sources and description {.tabset .tabset-fade}

We accessed data about Esports Earnings through tournaments on the website [EsportsEarnings.com](http://www.esportsearnings.com) (hereafter abbreviated as  `EE`).

This website provides a rather complete API to gather data in convenient format, through multiple *methods*. Due to website limitations (and to prevent excessive traffic on their side), we are only able to get a dataset (max. 100 rows) every second at most.

Therefore, we wrote a function `build_df()` that automates the process of making API requests and builds complete datasets, 100 rows at a time, for several different methods. This function can be found in the `scripts/Functions.R` script.

Using this, we gathered several data-sets (see `scripts/EE_Data_Gathering-01.R` for details):

### Data overview

```{r}
data1 <- read_delim(file = here::here("data/Twitch.csv"), ";", 
                    escape_double = FALSE, col_names = FALSE, trim_ws = TRUE)

# Data cleaning

TwitchData <- data1 %>%
  # set a name for each variable
  rename(Date = X1, Avg_concur_viewers = X2, 
         Avg_concur_channels = X3, Hours_watched = X4, 
         Active_streamers = X5, Hours_streamed = X6) %>%
  # modify the format of certain variable
  mutate(Date = mdy(Date), 
         Hours_watched = parse_number(Hours_watched)*1000000,
         Hours_streamed = Hours_streamed) %>%
  # Replace value with NA (in our dataframe, n/a are considered as character)
  replace_with_na(replace = list(Active_streamers = "n/a")) %>%
  mutate(Viewers_per_streamer = Hours_watched*100000000/Hours_streamed) %>%
  # Convert the column from character to double
  mutate(Active_streamers = parse_number(Active_streamers))

# Data overview

TwitchData %>% 
   kbl(caption = "Twitch statistics") %>%  
   kable_paper(full_width = F) %>% 
   scroll_box(width = "100%", height = "300px")
```

<p>&nbsp;</p>

We can see that these data consist of 99 observations of 7 attributes. 

Here is a description of each attribute :
   
- `Date` : month in which the data apply
- `Avg_concur_viewers` : Number of viewers connected in the same time in average 
- `Avg_concur_channels` : Number of channels connected in the same time in average 
- `Hours_watched` (in million) : Total number of hours watched per month
- `Active_streamers` : Total number of active channels
- `Hours_streamed` : Total number of hours streamed per month
- `Viewers_per_streamer` : Average number of viewers per streamer per month

This data-set contains missing location for 12 tournaments, and a missing tournament name for 1 of them (all of which have pool prizes of less than 20k USD).


### Missing value

```{r}
showna <- freq.na(TwitchData)
showna
```

<p>&nbsp;</p>

Except for active streamer we are good.

## Exploratory Data Analysis

Not all games in our data-sets have equal potential to attract masses. To explore which games are the most popular, we analysed them on different metrics:

### Ranking games {.tabset .tabset-fade}

#### Average concurent viewers

```{r}
plot_ly(type = "bar",
        x = TwitchData$Date, 
        y = TwitchData$Avg_concur_viewers,
        height = 400) %>%
  layout(xaxis = list(title="Date"),
         title = "Average concurent viewers")
```

Average concurent viewers over the time


#### Average concurent channels

```{r}
plot_ly(type = "bar",
        x = TwitchData$Date, 
        y = TwitchData$Avg_concur_channels,
        height = 400) %>%
  layout(xaxis = list(title="Date"),
         title = "Average concurent channels")
```

Average concurent channels over the time

#### Total number of hours watched per month :

```{r}
plot_ly(type = "bar",
        x = TwitchData$Date, 
        y = TwitchData$Hours_watched,
        height = 400) %>%
  layout(xaxis = list(title="Date"),
         title = "Total Hours watched")
```

Total Hours watched over time

#### Total number of active channels

```{r}
plot_ly(type = "bar",
        x = TwitchData$Date, 
        y = TwitchData$Active_streamers,
        height = 400) %>%
  layout(xaxis = list(title="Date"),
         title = "Total number of active streamers")
```

Total number of active channels over time

#### Total number of hours streamed per month

```{r}
plot_ly(type = "bar",
        x = TwitchData$Date, 
        y = TwitchData$Hours_streamed,
        height = 400) %>%
  layout(xaxis = list(title="Date"),
         title = "Total number of hours streamed")
```

Total number of hours streamed over the time

#### Average number of viewers per streamer per month

```{r}
plot_ly(type = "bar",
        x = TwitchData$Date, 
        y = TwitchData$Viewers_per_streamer,
        height = 400) %>%
  layout(xaxis = list(title="Date"),
         title = "Viewers per streamer on average")
```

Viewers per streamer on average over the time 

<hr/>

### {-}

From these observations, we can identify several pattern :

- number 1
- number 2


For the rest of this analysis, let's keep an eye out on these games.

### Dynamic graph {.tabset .tabset-fade}

Although these data are interesting, they do not mention anything about time. A game can gain popularity, but also lose it very fast for many reasons.

Using our `tournaments` data-set, we can see how tournament counts and prize-pools have evolved through time for each games.

#### Comparaison

```{r}
plot_ly(data = TwitchData, x = ~TwitchData$Date, y = ~TwitchData$Hours_watched
        ,type = "scatter", mode = "lines", width = 800
        ,name = "Hours watched", height = 400) %>%
  add_trace(x = ~TwitchData$Date, y = ~TwitchData$Hours_streamed, yaxis = "y2", name = "Hours streamed") %>%
  add_trace(x = ~TwitchData$Date, y = ~TwitchData$Viewers_per_streamer, yaxis = "y3", name = "Viewers per steamers")%>%
  layout(
    yaxis = list(
      showline = FALSE, side = "left"
      ,title = ""
      , color = "blue"
    )
    ,yaxis2 = list(
      showline = FALSE
      ,overlaying = "y"
      ,title = ""
      , anchor = "free"
      , color = "orange"
    )
    ,yaxis3 = list(
      showline = FALSE,
      side = "right",
      overlaying = "y"
      ,title = ""
      , color = "green"
    )
    ,xaxis = list(
      showline = FALSE, zeroline = FALSE, dtick = 0, title = "Date"
    )
    ,showlegend = TRUE
    ,margin = list(
      pad = 30, b = 90, l = 150, r = 90
    )
    ,legend = list(orientation = "v")
    , title = "Comparaison between watched and streamed"
  )
```


#### Step by step

```{r}
# Create function to set the frame 

accumulate_by <- function(dat, var) {
  var <- lazyeval::f_eval(var, dat)
  lvls <- plotly:::getLevels(var)
  dats <- lapply(seq_along(lvls), function(x) {
    cbind(dat[var %in% lvls[seq(1, x)], ], frame = lvls[[x]])
  })
  dplyr::bind_rows(dats)
}


# Arrange the actual data-set

bf <- TwitchData %>% separate(Date, into = c("year", "month", "day")) %>%
  mutate(day = NULL) %>% 
  unite(Date, year, month, sep = "-") %>% 
  arrange(Date) %>% mutate(ID = 1:99) %>% 
  accumulate_by(~ID)

# Build the dynamic plot
ggplotly(ggplot(bf, aes(ID, Hours_streamed, frame = frame)) +
                  geom_line(), height = 400) %>%
  layout(
    title = "Hours watched",
    yaxis = list(
      title = "Total ammount",
      zeroline = F,
      tickprefix = "$"
    ),
    xaxis = list(
      title = "Month",
      zeroline = F, 
      showgrid = F
    )
  ) %>% 
  animation_opts(
    frame = 30, 
    transition = 0, 
    redraw = FALSE
  ) %>%
  animation_slider(
    currentvalue = list(
      prefix = "Month "
  )
)
```